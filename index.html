<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>HuanXiBot V3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- æœ¬åœ° ethers.jsï¼ˆç¡®ä¿åŒç›®å½•ä¸‹æœ‰ ethers.min.jsï¼‰ -->
  <script src="./ethers.min.js"></script>
  <style>
    :root{
      --bg0:#020617;
      --bg1:#0b1220;
      --card: rgba(15,23,42,0.92);
      --stroke: rgba(75,85,99,0.75);
      --muted:#9ca3af;
      --text:#e5e7eb;
      --good:#4ade80;
      --warn:#fb923c;
      --bad:#fca5a5;
      --cyan:#38bdf8;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --logH: 190px;
    }
    * { box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, var(--bg0) 55%, #000 100%);
      color:var(--text);
      overflow:hidden; /* å…³é”®ï¼šé¡µé¢ä¸æ•´ä½“æ»šåŠ¨ */
    }
    a{ color:var(--cyan); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* ===== App Layout ===== */
    .app{
      height: 100%;
      display:flex;
      flex-direction:column;
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 14px 0;
      gap: 12px;
    }

    header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap: 10px 14px;
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-size: 22px; font-weight: 800;
      letter-spacing: .2px;
    }
    .pill{
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.7);
      display:inline-flex; align-items:center; gap:6px;
      color: var(--muted);
      font-weight: 600;
      white-space: nowrap;
    }
    .subtitle{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.45;
    }

    .right-actions{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      gap: 8px;
    }

    .btn{
      border-radius: 999px;
      padding: 8px 16px;
      background: linear-gradient(to right, #22c55e, #16a34a);
      color:white;
      border:none;
      cursor:pointer;
      font-size: 13px;
      font-weight: 700;
      display:inline-flex; align-items:center; gap:6px;
      box-shadow: 0 10px 25px rgba(34,197,94,0.28);
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    .btn-secondary{
      border-radius: 999px;
      padding: 8px 14px;
      background: rgba(31,41,55,0.9);
      color: var(--text);
      border: 1px solid rgba(75,85,99,0.85);
      cursor:pointer;
      font-size: 13px;
      font-weight: 650;
    }
    .btn-secondary:hover{ filter:brightness(1.08); }
    .btn-ghost{
      border-radius: 999px;
      padding: 8px 12px;
      background: rgba(15,23,42,0.25);
      color: var(--text);
      border: 1px solid rgba(75,85,99,0.55);
      cursor:pointer;
      font-size: 13px;
      font-weight: 650;
    }
    .btn-ghost:hover{ filter:brightness(1.12); }

    /* ===== Status Bar ===== */
    .status-bar{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      font-size: 12px;
    }
    .status-pill{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(55,65,81,0.85);
      display:inline-flex; align-items:center; gap:7px;
      box-shadow: 0 8px 22px rgba(0,0,0,.18);
    }
    .status-pill .label{ color: var(--muted); font-weight: 650; }
    .status-pill .value{ font-weight: 700; }
    .status-pill .value.muted{ color: var(--muted); font-weight: 650; }
    .status-pill .mini-btn{
      margin-left: 4px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.75);
      background: rgba(31,41,55,0.75);
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
      font-weight: 650;
    }
    .status-pill .mini-btn:hover{ filter:brightness(1.12); }

    /* ===== Toggle ===== */
    .seg{
      display:inline-flex;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(75,85,99,0.85);
      background: rgba(15,23,42,0.6);
    }
    .seg button{
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 13px;
      font-weight: 750;
      display:inline-flex; align-items:center; gap:6px;
    }
    .seg button.active{
      background: rgba(56,189,248,0.12);
      color: var(--text);
    }

    /* ===== Main (Tabs) ===== */
    .main{
      flex:1;
      min-height: 0; /* allow overflow */
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding-bottom: calc(var(--logH) + 12px); /* ç»™åº•éƒ¨æ—¥å¿—è…¾ä½ç½® */
    }
    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }
    .tab-btn{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.8);
      background: rgba(15,23,42,0.65);
      color: var(--muted);
      cursor:pointer;
      font-size: 13px;
      font-weight: 780;
    }
    .tab-btn.active{
      background: rgba(34,197,94,0.15);
      color: var(--text);
      border-color: rgba(34,197,94,0.55);
    }

    .panel-wrap{
      flex:1;
      min-height: 0;
      overflow:auto;
      padding-right: 6px;
    }
    .panel{
      display:none;
      animation: fadeIn .12s ease-in;
    }
    .panel.active{ display:block; }
    @keyframes fadeIn{ from{opacity:.65; transform: translateY(2px);} to{opacity:1; transform: translateY(0);} }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px 14px 16px;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }
    .card-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .card-title{
      font-size: 15px;
      font-weight: 850;
      margin: 0;
    }
    .badge{
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--muted);
      background: rgba(15,23,42,0.35);
      white-space: nowrap;
      font-weight: 700;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.55;
      margin: 6px 0 10px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 900px){
      body{ overflow:auto; } /* å°å±å…è®¸æ•´ä½“æ»šåŠ¨é¿å…é®æŒ¡ */
      .app{ height:auto; overflow:visible; padding-bottom: calc(var(--logH) + 16px); }
      .main{ padding-bottom: 0; }
      .panel-wrap{ overflow:visible; }
      .grid{ grid-template-columns: 1fr; }
      .log-dock{ position: sticky; bottom: 0; }
    }

    .field{ margin-bottom: 10px; }
    .field label{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      font-size: 12px;
      margin-bottom: 4px;
      color: #d1d5db;
      gap: 8px;
      font-weight: 650;
    }
    .field small{
      color: var(--muted);
      font-size: 11px;
      font-weight: 600;
    }
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,0.92);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 13px;
    }
    textarea{ min-height: 86px; max-height: 210px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color: var(--cyan);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.28);
    }

    .row{
      display:flex; gap: 10px; align-items:center; flex-wrap:wrap;
    }
    .row .grow{ flex:1; min-width: 220px; }

    .footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .msg{
      margin-top: 8px;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .msg.ok{ color: var(--good); }
    .msg.err{ color: var(--bad); }

    code{
      font-size: 11px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(75,85,99,0.55);
      border-radius: 8px;
      padding: 2px 7px;
    }

    /* ===== Log Dock ===== */
    .log-dock{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: min(1200px, 100vw);
      height: var(--logH);
      padding: 10px 14px 12px;
      background: rgba(2,6,23,0.88);
      border-top: 1px solid rgba(75,85,99,0.65);
      backdrop-filter: blur(8px);
      box-shadow: 0 -18px 40px rgba(0,0,0,.55);
      z-index: 99;
    }
    .log-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .log-title{
      display:flex; align-items:center; gap: 10px;
      font-size: 13px; font-weight: 850;
      margin: 0;
    }
    .log-title .muted{ color: var(--muted); font-weight: 650; font-size: 12px; }
    .log-actions{
      display:flex; align-items:center; gap: 8px; flex-wrap:wrap;
    }
    .log-body{
      height: calc(var(--logH) - 46px);
      overflow:auto;
      border-radius: 12px;
      border: 1px solid rgba(75,85,99,0.55);
      background: rgba(15,23,42,0.62);
      padding: 8px;
    }
    .log-item{
      display:flex;
      gap: 10px;
      padding: 8px 8px;
      border-radius: 12px;
      border: 1px solid rgba(75,85,99,0.35);
      background: rgba(2,6,23,0.32);
      margin-bottom: 8px;
    }
    .log-meta{
      min-width: 190px;
      max-width: 220px;
      display:flex;
      flex-direction:column;
      gap: 4px;
      font-size: 12px;
    }
    .log-meta .fn{ font-weight: 850; }
    .log-meta .ts{ color: var(--muted); font-weight: 650; font-size: 11px; }
    .log-meta .tag{
      display:inline-flex;
      width: fit-content;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 750;
      border: 1px solid rgba(148,163,184,0.35);
      color: var(--muted);
      background: rgba(15,23,42,0.25);
    }
    .log-data{
      flex:1;
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .hex{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 11px;
      line-height: 1.45;
      word-break: break-all;
      color: #d1d5db;
    }
    .log-btns{
      display:flex;
      gap: 8px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .mini{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.7);
      background: rgba(31,41,55,0.6);
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
      font-weight: 700;
    }
    .mini:hover{ filter: brightness(1.12); }

    .warn{ color: var(--warn); }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    .hidden{ display:none !important; }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div>
      <div class="title">
        ğŸ’µğŸ’µğŸ’µ HuanXiBot V3
        <span class="pill">BNB Chain Â· æ‰¹é‡ä¹°å…¥ / ç©ºæŠ• / æç° / æŸ¥è¯¢</span>
      </div>
      <div class="subtitle">
        ä»…åˆçº¦ Owner å¯è°ƒç”¨ã€‚BNBèŠ±è´¹Owneré’±åŒ…ä½™é¢ï¼Œå…¶ä»–ä¸€å¾‹èŠ±è´¹åˆçº¦å†…ä½™é¢ã€‚<br>
         <code>ä»…æ˜¾ç¤ºdata</code>ï¼ˆä¸å¼¹ MetaMaskï¼‰ï¼Œ<code>å‘èµ·äº¤æ˜“</code>ï¼ˆå¼¹ MetaMaskï¼‰ã€‚
      </div>
    </div>

    <div class="right-actions">
      <div class="seg" title="é€‰æ‹©ï¼šä»…æ˜¾ç¤º dataï¼ˆä¸è°ƒç”¨ MetaMaskï¼‰ æˆ– å‘èµ·äº¤æ˜“ï¼ˆè°ƒç”¨ MetaMaskï¼‰">
        <button id="modeDataOnly" class="active">ä»…æ˜¾ç¤ºdata</button>
        <button id="modeSend">å‘èµ·äº¤æ˜“</button>
      </div>
      <button id="connectBtn" class="btn">è¿æ¥ MetaMask</button>
    </div>
  </header>

  <div class="status-bar">
    <div class="status-pill">
      <span class="label">é’±åŒ…</span>
      <span class="value" id="walletAddress">æœªè¿æ¥</span>
    </div>
    <div class="status-pill">
      <span class="label">ç½‘ç»œ</span>
      <span class="value muted" id="networkName">-</span>
    </div>
    <div class="status-pill">
      <span class="label">åˆçº¦</span>
      <span class="value">
        <a id="contractLink" href="#" target="_blank" rel="noreferrer">-</a>
      </span>
    </div>
    <div class="status-pill">
      <span class="label">æƒé™</span>
      <span class="value" id="ownerFlag">æœªçŸ¥</span>
    </div>
    <div class="status-pill">
      <span class="label">è¿è¡Œ</span>
      <span class="value" id="pausedFlag">-</span>
    </div>
    <div class="status-pill" title="è¿™é‡Œæ˜¾ç¤ºåˆçº¦æŒæœ‰çš„ payTokenï¼ˆé€šå¸¸æ˜¯ USDTï¼‰ä½™é¢">
      <span class="label">åˆçº¦ USDT ä½™é¢</span>
      <span class="value" id="contractUSDTBalance">-</span>
      <button class="mini-btn" id="refreshBalanceBtn">åˆ·æ–°</button>
    </div>
  </div>

  <div class="main">
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-normal">æ™®é€šè´­ä¹°æ¨¡å¼</button>
      <button class="tab-btn" data-tab="tab-limited">é™é¢è´­ä¹°æ¨¡å¼</button>
      <button class="tab-btn" data-tab="tab-batch">æ‰¹é‡å·¥å…·</button>
      <button class="tab-btn" data-tab="tab-withdraw">æç°</button>
      <button class="tab-btn" data-tab="tab-balance">æŸ¥è¯¢ä½™é¢</button>
      <button class="tab-btn" data-tab="tab-security">å®‰å…¨å¼€å…³</button>
    </div>

    <div class="panel-wrap">
      <!-- ===== æ™®é€šè´­ä¹° ===== -->
      <section class="panel active" id="tab-normal">
        <div class="card">
          <div class="card-head">
            <h3 class="card-title">æ™®é€šè´­ä¹°</h3>
            <span class="badge">æ¯ä¸ªåœ°å€å›ºå®šèŠ±è´¹</span>
          </div>
          <div class="hint">
            é€‰æ‹©æ”¯ä»˜æ–¹å¼åï¼Œå¡«å†™ï¼šç›®æ ‡ä»£å¸ + æ¯ä¸ªåœ°å€èŠ±è´¹ + æ”¶å¸åœ°å€åˆ—è¡¨ã€‚<br>
            äº¤æ˜“æŒ‰é’®ä¸€ç‚¹å‡»å°±ä¼šæŠŠæœ¬æ¬¡äº¤æ˜“çš„ <code>data</code> è®°å½•åˆ°ä¸‹æ–¹æ—¥å¿—ï¼ˆæˆåŠŸ/å¤±è´¥/æ‹’ç»éƒ½è®°å½•ï¼‰ã€‚
          </div>

          <form id="form-normal">
            <div class="grid">
              <div class="field">
                <label>
                  <span>æ”¯ä»˜æ–¹å¼</span>
                  <small>BNB / USDT / è‡ªå®šä¹‰ä»£å¸</small>
                </label>
                <select id="normal-payType">
                  <option value="BNB">BNB æ™®é€šè´­ä¹°</option>
                  <option value="USDT">USDT æ™®é€šè´­ä¹°</option>
                  <option value="CUSTOM">è‡ªå®šä¹‰ä»£å¸æ™®é€šè´­ä¹°</option>
                </select>
              </div>

              <div class="field hidden" id="normal-payTokenBox">
                <label>
                  <span>èŠ±è´¹ä»£å¸åœ°å€ï¼ˆpayTokenAddrï¼‰</span>
                  <small>ä»…è‡ªå®šä¹‰ä»£å¸æ¨¡å¼éœ€è¦</small>
                </label>
                <input type="text" id="normal-payTokenAddr" placeholder="0x... èŠ±è´¹ä»£å¸åˆçº¦åœ°å€" />
              </div>
            </div>

            <div class="field">
              <label><span>ç›®æ ‡ä»£å¸åœ°å€ï¼ˆtokenToBuyï¼‰</span></label>
              <input type="text" id="normal-tokenToBuy" placeholder="0x... ç›®æ ‡ä»£å¸åˆçº¦åœ°å€" required />
            </div>

            <div class="field">
              <label>
                <span>æ¯ä¸ªåœ°å€èŠ±è´¹æ•°é‡</span>
                <small>è‡ªåŠ¨æ¢ç®— decimals / weiï¼Œä¸éœ€è¦æ‰‹åŠ¨åŠ  0</small>
              </label>
              <input type="number" step="0.000000000000000001" min="0" id="normal-amountPer"
                     placeholder="ä¾‹å¦‚ï¼š0.01ï¼ˆBNBï¼‰æˆ– 100ï¼ˆUSDTï¼‰" required />
            </div>

            <div class="field">
              <label>
                <span>æ”¶å¸åœ°å€åˆ—è¡¨ï¼ˆä¸€è¡Œä¸€ä¸ªåœ°å€ï¼‰</span>
                <small>æ”¯æŒæ¢è¡Œ/é€—å·åˆ†éš”</small>
              </label>
              <textarea id="normal-recipients" placeholder="0xåœ°å€1&#10;0xåœ°å€2&#10;0xåœ°å€3"></textarea>
            </div>

            <div class="footer">
              <div class="hint" style="margin:0">
                ğŸ’¡ æç¤ºï¼šå»ºè®®å…ˆç”¨æå°é‡‘é¢æµ‹è¯•ï¼›åˆçº¦è‹¥å¤„äºæš‚åœçŠ¶æ€ï¼Œä¹°å…¥ä¼šè¢«æ‹’ç»ã€‚
              </div>
              <button type="submit" class="btn" id="normal-submit">å‘é€äº¤æ˜“</button>
            </div>

            <div id="normal-msg" class="msg"></div>
          </form>
        </div>
      </section>

      <!-- ===== é™é¢è´­ä¹° ===== -->
      <section class="panel" id="tab-limited">
        <div class="card">
          <div class="card-head">
            <h3 class="card-title">é™é¢è´­ä¹°</h3>
            <span class="badge">æ¯åœ°å€ï¼šæœ€å¤§èŠ±è´¹ + ç›®æ ‡ä¹°å…¥æ•°é‡</span>
          </div>
          <div class="hint">
            ä¸€è¡Œä¸€ä¸ªé…ç½®ï¼š<code>åœ°å€, æœ€å¤§èŠ±è´¹, ç›®æ ‡ä¹°å…¥æ•°é‡</code><br>
            ç›®æ ‡ä¹°å…¥æ•°é‡ä¸º <code>0</code> è¡¨ç¤ºâ€œå…¨åŠ›ä¹°â€ï¼ˆæŒ‰æœ€å¤§èŠ±è´¹å°½å¯èƒ½ä¹°å…¥ï¼‰ã€‚
          </div>

          <form id="form-limited">
            <div class="grid">
              <div class="field">
                <label>
                  <span>æ”¯ä»˜æ–¹å¼</span>
                  <small>BNB / USDT / è‡ªå®šä¹‰ä»£å¸</small>
                </label>
                <select id="limited-payType">
                  <option value="BNB">BNB é™é¢è´­ä¹°</option>
                  <option value="USDT">USDT é™é¢è´­ä¹°</option>
                  <option value="CUSTOM">è‡ªå®šä¹‰ä»£å¸é™é¢è´­ä¹°</option>
                </select>
              </div>

              <div class="field hidden" id="limited-payTokenBox">
                <label>
                  <span>èŠ±è´¹ä»£å¸åœ°å€ï¼ˆpayTokenAddrï¼‰</span>
                  <small>ä»…è‡ªå®šä¹‰ä»£å¸æ¨¡å¼éœ€è¦</small>
                </label>
                <input type="text" id="limited-payTokenAddr" placeholder="0x... èŠ±è´¹ä»£å¸åˆçº¦åœ°å€" />
              </div>
            </div>

            <div class="field">
              <label><span>ç›®æ ‡ä»£å¸åœ°å€ï¼ˆtokenToBuyï¼‰</span></label>
              <input type="text" id="limited-tokenToBuy" placeholder="0x... ç›®æ ‡ä»£å¸åˆçº¦åœ°å€" required />
            </div>

            <div class="field">
              <label>
                <span>åœ°å€é…ç½®åˆ—è¡¨</span>
                <small>æ ¼å¼ï¼šåœ°å€, æœ€å¤§èŠ±è´¹, ç›®æ ‡ä¹°å…¥æ•°é‡</small>
              </label>
              <textarea id="limited-params"
                placeholder="0xåœ°å€1, 0.05, 1000&#10;0xåœ°å€2, 0.02, 500&#10;0xåœ°å€3, 0.01, 0"></textarea>
            </div>

            <div class="footer">
              <div class="hint" style="margin:0">
                ğŸ’¡ BNB æ¨¡å¼ä¼šè‡ªåŠ¨æŠŠâ€œæœ€å¤§èŠ±è´¹ä¹‹å’Œâ€ä½œä¸º <code>value</code>ï¼›USDT/è‡ªå®šä¹‰ä»£å¸ä»åˆçº¦ä½™é¢æ‰£ã€‚
              </div>
              <button type="submit" class="btn" id="limited-submit">å‘é€äº¤æ˜“</button>
            </div>

            <div id="limited-msg" class="msg"></div>
          </form>
        </div>
      </section>

      <!-- ===== æ‰¹é‡å·¥å…· ===== -->
      <section class="panel" id="tab-batch">
        <div class="card">
          <div class="card-head">
            <h3 class="card-title">æ‰¹é‡ç©ºæŠ•</h3>
            <span class="badge">BNB / USDT / è‡ªå®šä¹‰ä»£å¸</span>
          </div>
          <div class="hint">
            é€‰æ‹©ç©ºæŠ•ç±»å‹åå¡«å†™æ¯åœ°å€æ•°é‡å’Œåœ°å€åˆ—è¡¨ã€‚USDT ç©ºæŠ•æœ¬è´¨ä¸Šæ˜¯ç»™ payTokenï¼ˆé€šå¸¸æ˜¯ USDTï¼‰è°ƒç”¨ç©ºæŠ•ã€‚
          </div>

          <form id="form-airdrop">
            <div class="grid">
              <div class="field">
                <label>
                  <span>ç©ºæŠ•ç±»å‹</span>
                  <small>BNB / USDT / è‡ªå®šä¹‰ä»£å¸</small>
                </label>
                <select id="airdrop-type">
                  <option value="BNB">æ‰¹é‡ç©ºæŠ• BNB</option>
                  <option value="USDT">æ‰¹é‡ç©ºæŠ• USDT</option>
                  <option value="CUSTOM">æ‰¹é‡ç©ºæŠ• è‡ªå®šä¹‰ä»£å¸</option>
                </select>
              </div>

              <div class="field hidden" id="airdrop-tokenBox">
                <label>
                  <span>èŠ±è´¹ä»£å¸åœ°å€ï¼ˆtokenï¼‰</span>
                  <small>ä»…è‡ªå®šä¹‰ä»£å¸æ¨¡å¼éœ€è¦</small>
                </label>
                <input type="text" id="airdrop-tokenAddr" placeholder="0x... è¦ç©ºæŠ•çš„ä»£å¸åˆçº¦åœ°å€" />
              </div>
            </div>

            <div class="field">
              <label>
                <span>æ¯ä¸ªåœ°å€ç©ºæŠ•æ•°é‡</span>
                <small>è‡ªåŠ¨æ¢ç®— decimals / wei</small>
              </label>
              <input type="number" step="0.000000000000000001" min="0" id="airdrop-amountPer"
                     placeholder="ä¾‹å¦‚ï¼š0.005ï¼ˆBNBï¼‰æˆ– 100ï¼ˆUSDTï¼‰" required />
            </div>

            <div class="field">
              <label><span>åœ°å€åˆ—è¡¨ï¼ˆä¸€è¡Œä¸€ä¸ªåœ°å€ï¼‰</span></label>
              <textarea id="airdrop-recipients" placeholder="0xåœ°å€1&#10;0xåœ°å€2"></textarea>
            </div>

            <div class="footer">
              <div class="hint" style="margin:0">
                ğŸ’¡ ç©ºæŠ•èµ„é‡‘æ¥è‡ªåˆçº¦ä½™é¢ï¼›è¯·å…ˆç¡®ä¿åˆçº¦æœ‰è¶³å¤Ÿä½™é¢ã€‚
              </div>
              <button type="submit" class="btn" id="airdrop-submit">æ‰§è¡Œç©ºæŠ•</button>
            </div>

            <div id="airdrop-msg" class="msg"></div>
          </form>
        </div>
      </section>

      <!-- ===== æç° ===== -->
      <section class="panel" id="tab-withdraw">
        <div class="card">
          <div class="card-head">
            <h3 class="card-title">æç°</h3>
            <span class="badge">BNB / USDT / è‡ªå®šä¹‰ä»£å¸</span>
          </div>
          <div class="hint">
            USDT æç°ä¼šè‡ªåŠ¨ä½¿ç”¨åˆçº¦çš„ <code>payToken</code> åœ°å€ï¼ˆé€šå¸¸æ˜¯ USDTï¼‰ã€‚<br>
            æ•°é‡ç›´æ¥å†™æ­£å¸¸æ•°å­—å³å¯ï¼Œå‰ç«¯ä¼šè‡ªåŠ¨æŒ‰ decimals æ¢ç®—ã€‚
          </div>

          <form id="form-withdraw">
            <div class="grid">
              <div class="field">
                <label>
                  <span>æç°ç±»å‹</span>
                  <small>BNB / USDT / è‡ªå®šä¹‰ä»£å¸</small>
                </label>
                <select id="withdraw-type">
                  <option value="BNB">æç° BNB</option>
                  <option value="USDT">æç° USDT</option>
                  <option value="CUSTOM">æç° è‡ªå®šä¹‰ä»£å¸</option>
                </select>
              </div>

              <div class="field hidden" id="withdraw-tokenBox">
                <label>
                  <span>æç°ä»£å¸åœ°å€ï¼ˆtokenï¼‰</span>
                  <small>ä»…è‡ªå®šä¹‰ä»£å¸æ¨¡å¼éœ€è¦</small>
                </label>
                <input type="text" id="withdraw-tokenAddr" placeholder="0x... æç°ä»£å¸åˆçº¦åœ°å€" />
              </div>
            </div>

            <div class="grid">
              <div class="field">
                <label><span>æ¥æ”¶åœ°å€ï¼ˆtoï¼‰</span></label>
                <input type="text" id="withdraw-to" placeholder="0x... æ¥æ”¶åœ°å€" required />
              </div>
              <div class="field">
                <label>
                  <span>æç°æ•°é‡ï¼ˆamountï¼‰</span>
                  <small>å¤§äºä½™é¢æ—¶åˆçº¦é€šå¸¸ä¼šå…¨éƒ¨æèµ°ï¼ˆè§†åˆçº¦å®ç°ï¼‰</small>
                </label>
                <input type="number" step="0.000000000000000001" min="0" id="withdraw-amount"
                       placeholder="ä¾‹å¦‚ï¼š0.1ï¼ˆBNBï¼‰æˆ– 100ï¼ˆUSDTï¼‰" required />
              </div>
            </div>

            <div class="footer">
              <div class="hint" style="margin:0">
                ğŸ’¡ è‹¥è¦æç°è‡ªå®šä¹‰ä»£å¸ï¼Œè¯·å…ˆç¡®è®¤åˆçº¦æŒæœ‰è¯¥ä»£å¸ä½™é¢ã€‚
              </div>
              <button type="submit" class="btn" id="withdraw-submit">å‘é€äº¤æ˜“</button>
            </div>

            <div id="withdraw-msg" class="msg"></div>
          </form>
        </div>
      </section>

      <!-- ===== æŸ¥è¯¢ä½™é¢ ===== -->
      <section class="panel" id="tab-balance">
        <div class="card">
          <div class="card-head">
            <h3 class="card-title">æŸ¥è¯¢ä½™é¢</h3>
            <span class="badge">åˆçº¦ä½™é¢æŸ¥è¯¢</span>
          </div>
          <div class="hint">
            æŸ¥è¯¢åˆçº¦å†… BNB / USDT / è‡ªå®šä¹‰ä»£å¸ä½™é¢ã€‚USDT æŸ¥è¯¢ä¼šè‡ªåŠ¨ä½¿ç”¨ <code>payToken</code>ã€‚
          </div>

          <form id="form-balance">
            <div class="grid">
              <div class="field">
                <label><span>æŸ¥è¯¢ç±»å‹</span></label>
                <select id="balance-type">
                  <option value="BNB">æŸ¥è¯¢åˆçº¦å†… BNB ä½™é¢</option>
                  <option value="USDT">æŸ¥è¯¢åˆçº¦å†… USDT ä½™é¢</option>
                  <option value="CUSTOM">æŸ¥è¯¢åˆçº¦å†… è‡ªå®šä¹‰ä»£å¸ä½™é¢</option>
                </select>
              </div>

              <div class="field hidden" id="balance-tokenBox">
                <label>
                  <span>æŸ¥è¯¢ä»£å¸åœ°å€ï¼ˆtokenï¼‰</span>
                  <small>ä»…è‡ªå®šä¹‰ä»£å¸æ¨¡å¼éœ€è¦</small>
                </label>
                <input type="text" id="balance-tokenAddr" placeholder="0x... æŸ¥è¯¢ä»£å¸åˆçº¦åœ°å€" />
              </div>
            </div>

            <div class="footer">
              <div class="hint" style="margin:0">
                ğŸ’¡ ä½™é¢æŸ¥è¯¢ä¸å‘äº¤æ˜“ï¼ˆä¸ä¼šå¼¹ MetaMaskï¼‰ã€‚
              </div>
              <button type="submit" class="btn-secondary" id="balance-submit">æŸ¥è¯¢</button>
            </div>

            <div id="balance-msg" class="msg"></div>
          </form>
        </div>
      </section>

      <!-- ===== å®‰å…¨å¼€å…³ ===== -->
      <section class="panel" id="tab-security">
        <div class="card">
          <div class="card-head">
            <h3 class="card-title">å®‰å…¨å¼€å…³ï¼ˆæš‚åœ / æ¢å¤ï¼‰</h3>
            <span class="badge">æš‚åœåä¹°å…¥/ç©ºæŠ•æ‹’ç»æ‰§è¡Œï¼Œä½†å¯æç°</span>
          </div>
          <div class="hint" id="pausedStateText">å½“å‰çŠ¶æ€ï¼šæœªçŸ¥</div>

          <div class="footer">
            <div class="hint" style="margin:0">
              âš ï¸ è‹¥ä½ æ‹…å¿ƒè¯¯æ“ä½œï¼Œå¯å…ˆåˆ‡åˆ°ã€Œä»…æ˜¾ç¤ºdataã€æ¨¡å¼ï¼Œç¡®è®¤ data æ— è¯¯åå†åˆ‡ã€Œå‘èµ·äº¤æ˜“ã€ã€‚
            </div>
            <div class="row">
              <button class="btn-secondary" id="pause-btn">æš‚åœæ‰€æœ‰è´­ä¹°</button>
              <button class="btn-secondary" id="unpause-btn">æ¢å¤è´­ä¹°</button>
            </div>
          </div>

          <div id="pause-msg" class="msg"></div>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- ===== å›ºå®šåº•éƒ¨æ—¥å¿—æ  ===== -->
<div class="log-dock">
  <div class="log-head">
    <div class="log-title">
      ğŸ“œ äº¤æ˜“æ—¥å¿—
      <span class="muted">ï¼ˆç‚¹å‡»æŒ‰é’®å³è®°å½• dataï¼›æ—¥å¿—å¸¸é©»ä¸é®æŒ¡ä¸»åŠŸèƒ½ï¼‰</span>
    </div>
    <div class="log-actions">
      <button class="btn-ghost" id="copyLastBtn">å¤åˆ¶æœ€æ–° data</button>
      <button class="btn-ghost" id="copyAllBtn">å¤åˆ¶å…¨éƒ¨</button>
      <button class="btn-ghost" id="clearLogBtn">æ¸…ç©º</button>
    </div>
  </div>
  <div class="log-body" id="logBody"></div>
</div>

<script>
  // ===== åŸºæœ¬é…ç½®ï¼ˆå¦‚éœ€æ›´æ¢åˆçº¦ï¼Œæ”¹è¿™é‡Œï¼‰=====
  const CONTRACT_ADDRESS = "0xe39433810EC31f6F7d189079A1F334c4A08E9530"; // ä½ çš„ V2 åˆçº¦
  const BSCSCAN_ADDR = "https://bscscan.com/address/";

  const CONTRACT_ABI = [
    "function owner() view returns (address)",
    "function payToken() view returns (address)",
    "function paused() view returns (bool)",

    "function pause()",
    "function unpause()",

    "function buyWithBNB(address tokenToBuy, uint256 bnbPerAddress, address[] calldata recipients) payable",
    "function buyWithPayToken(address tokenToBuy, uint256 amountPerAddress, address[] calldata recipients)",
    "function buyWithCustomToken(address payTokenAddr, address tokenToBuy, uint256 amountPerAddress, address[] calldata recipients)",

    "function limitedBuyWithBNB(address tokenToBuy, (address recipient,uint256 maxPayAmount,uint256 targetBuyAmount)[] calldata params) payable",
    "function limitedBuyWithPayToken(address tokenToBuy, (address recipient,uint256 maxPayAmount,uint256 targetBuyAmount)[] calldata params)",
    "function limitedBuyWithCustomToken(address payTokenAddr, address tokenToBuy, (address recipient,uint256 maxPayAmount,uint256 targetBuyAmount)[] calldata params)",

    "function airdropBNB(uint256 amountPerAddress, address[] calldata recipients)",
    "function airdropTokenEqual(address token, uint256 amountPerAddress, address[] calldata recipients)",

    "function withdrawBNB(address to, uint256 amount)",
    "function withdrawToken(address token, address to, uint256 amount)"
  ];

  const ERC20_ABI = [
    "function decimals() view returns (uint8)",
    "function balanceOf(address account) view returns (uint256)"
  ];

  // ===== å…¨å±€çŠ¶æ€ =====
  let provider, signer, contract, currentAccount, contractOwner, currentNetwork;
  let txMode = "DATA"; // DATA | SEND
  const decimalsCache = new Map();

  // ===== DOM =====
  const connectBtn = document.getElementById("connectBtn");
  const walletAddressSpan = document.getElementById("walletAddress");
  const networkNameSpan = document.getElementById("networkName");
  const ownerFlagSpan = document.getElementById("ownerFlag");
  const pausedFlagSpan = document.getElementById("pausedFlag");
  const pausedStateText = document.getElementById("pausedStateText");
  const contractUSDTBalanceSpan = document.getElementById("contractUSDTBalance");
  const refreshBalanceBtn = document.getElementById("refreshBalanceBtn");
  const contractLink = document.getElementById("contractLink");

  const modeDataOnlyBtn = document.getElementById("modeDataOnly");
  const modeSendBtn = document.getElementById("modeSend");

  const logBody = document.getElementById("logBody");
  const copyLastBtn = document.getElementById("copyLastBtn");
  const copyAllBtn = document.getElementById("copyAllBtn");
  const clearLogBtn = document.getElementById("clearLogBtn");

  // ===== UI è¾…åŠ© =====
  function shortAddr(addr){
    if(!addr) return "-";
    return addr.slice(0,6) + "..." + addr.slice(-4);
  }
  function nowStr(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function setMsg(el, ok, text){
    el.className = "msg " + (ok ? "ok" : "err");
    el.textContent = text || "";
  }
  function parseAddressList(text){
    return (text || "")
      .split(/\n|,/)
      .map(s => s.trim())
      .filter(Boolean);
  }
  function parseLimitedParams(text){
    const lines = (text || "").split(/\n+/);
    const rows = [];
    for (const line of lines){
      if(!line.trim()) continue;
      const parts = line.split(",").map(p=>p.trim()).filter(Boolean);
      if(parts.length < 3) throw new Error("é™é¢é…ç½®è¡Œæ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨ï¼šåœ°å€, æœ€å¤§èŠ±è´¹, ç›®æ ‡æ•°é‡");
      rows.push({ addr: parts[0], maxPay: parts[1], target: parts[2] });
    }
    if(rows.length === 0) throw new Error("è¯·è‡³å°‘å¡«å†™ä¸€è¡Œåœ°å€é…ç½®ã€‚");
    return rows;
  }
  function normalizeAddr(a){ return (a || "").trim(); }

  // ===== æ—¥å¿— =====
  const LOG_KEY = "huanxi_v2_logs_v1";
  function loadLogs(){
    try{
      const raw = localStorage.getItem(LOG_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch{ return []; }
  }
  function saveLogs(items){
    try{ localStorage.setItem(LOG_KEY, JSON.stringify(items.slice(0,80))); }catch{}
  }
  let logs = loadLogs(); // [{ts, fn, tag, data, extra}]
  function renderLogs(){
    logBody.innerHTML = "";
    if(!logs.length){
      const empty = document.createElement("div");
      empty.className = "hex";
      empty.textContent = "æš‚æ— æ—¥å¿—ã€‚ç‚¹å‡»ä»»ä½•ã€å‘é€äº¤æ˜“/æ‰§è¡Œç©ºæŠ•ã€‘æŒ‰é’®ï¼Œå³å¯åœ¨è¿™é‡Œçœ‹åˆ°æœ¬æ¬¡äº¤æ˜“çš„ dataï¼ˆcalldataï¼‰ã€‚";
      logBody.appendChild(empty);
      return;
    }
    logs.forEach((item, idx)=>{
      const wrap = document.createElement("div");
      wrap.className = "log-item";

      const meta = document.createElement("div");
      meta.className = "log-meta";
      meta.innerHTML = `
        <div class="fn">${item.fn || "-"}</div>
        <div class="ts">${item.ts || "-"}</div>
        <div class="tag">${item.tag || "-"}</div>
      `;

      const data = document.createElement("div");
      data.className = "log-data";
      const hex = document.createElement("div");
      hex.className = "hex";
      hex.textContent = item.data || "";
      const extra = document.createElement("div");
      extra.className = "hex";
      extra.style.color = "rgba(156,163,175,0.95)";
      extra.textContent = item.extra || "";
      data.appendChild(hex);
      if(item.extra) data.appendChild(extra);

      const btns = document.createElement("div");
      btns.className = "log-btns";
      const copyBtn = document.createElement("button");
      copyBtn.className = "mini";
      copyBtn.textContent = "å¤åˆ¶";
      copyBtn.addEventListener("click", ()=> copyText(item.data || ""));
      const delBtn = document.createElement("button");
      delBtn.className = "mini";
      delBtn.textContent = "åˆ é™¤";
      delBtn.addEventListener("click", ()=>{
        logs.splice(idx,1);
        saveLogs(logs);
        renderLogs();
      });
      btns.appendChild(copyBtn);
      btns.appendChild(delBtn);

      wrap.appendChild(meta);
      wrap.appendChild(data);
      wrap.appendChild(btns);
      logBody.appendChild(wrap);
    });
  }
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text || "");
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text || "";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  }
  function pushLog(fn, data, tag, extra){
    logs.unshift({ ts: nowStr(), fn, data, tag, extra: extra || "" });
    logs = logs.slice(0, 80);
    saveLogs(logs);
    renderLogs();
  }

  copyLastBtn.addEventListener("click", ()=>{
    if(!logs.length) return;
    copyText(logs[0].data || "");
  });
  copyAllBtn.addEventListener("click", ()=>{
    if(!logs.length) return;
    const all = logs.map(x=> `[${x.ts}] ${x.fn} ${x.tag}\n${x.data}\n`).join("\n");
    copyText(all);
  });
  clearLogBtn.addEventListener("click", ()=>{
    logs = [];
    saveLogs(logs);
    renderLogs();
  });

  // ===== æ¨¡å¼åˆ‡æ¢ =====
  function setMode(mode){
    txMode = mode;
    if(mode === "DATA"){
      modeDataOnlyBtn.classList.add("active");
      modeSendBtn.classList.remove("active");
    }else{
      modeDataOnlyBtn.classList.remove("active");
      modeSendBtn.classList.add("active");
    }
  }
  modeDataOnlyBtn.addEventListener("click", ()=> setMode("DATA"));
  modeSendBtn.addEventListener("click", ()=> setMode("SEND"));

  // ===== Tabs åˆ‡æ¢ =====
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab-btn").forEach(b=> b.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.dataset.tab;
      document.querySelectorAll(".panel").forEach(p=> p.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    });
  });

  // ===== Select åŠ¨æ€æ˜¾ç¤º =====
  function bindSelectShow(selectId, boxId, whenValue){
    const sel = document.getElementById(selectId);
    const box = document.getElementById(boxId);
    const update = ()=>{
      const v = sel.value;
      if(v === whenValue) box.classList.remove("hidden");
      else box.classList.add("hidden");
    };
    sel.addEventListener("change", update);
    update();
  }
  bindSelectShow("normal-payType", "normal-payTokenBox", "CUSTOM");
  bindSelectShow("limited-payType", "limited-payTokenBox", "CUSTOM");
  bindSelectShow("airdrop-type", "airdrop-tokenBox", "CUSTOM");
  bindSelectShow("withdraw-type", "withdraw-tokenBox", "CUSTOM");
  bindSelectShow("balance-type", "balance-tokenBox", "CUSTOM");

  // ===== é“¾æ¥åˆå§‹åŒ– =====
  contractLink.href = BSCSCAN_ADDR + CONTRACT_ADDRESS;
  contractLink.textContent = shortAddr(CONTRACT_ADDRESS);

  // ===== decimals helpersï¼ˆå¸¦ç¼“å­˜ï¼‰=====
  async function getTokenDecimals(tokenAddr){
    const key = (tokenAddr || "").toLowerCase();
    if(decimalsCache.has(key)) return decimalsCache.get(key);
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
    const dec = await token.decimals();
    decimalsCache.set(key, dec);
    return dec;
  }
  async function getTokenBalance(tokenAddr){
    const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
    return await token.balanceOf(CONTRACT_ADDRESS);
  }

  // ===== çŠ¶æ€åˆ·æ–°ï¼šç½‘ç»œ/owner/paused + USDTä½™é¢ =====
  async function refreshContractStatus(){
    if(!provider || !contract) return;
    try{
      const [network, ownerAddr, pausedVal] = await Promise.all([
        provider.getNetwork(),
        contract.owner(),
        contract.paused(),
      ]);
      currentNetwork = network;
      contractOwner = ownerAddr;

      networkNameSpan.textContent = `${network.name} (${network.chainId})`;

      const isOwner = currentAccount && contractOwner &&
        currentAccount.toLowerCase() === contractOwner.toLowerCase();

      ownerFlagSpan.textContent = isOwner ? "Owner" : "é Owner";
      ownerFlagSpan.style.color = isOwner ? "var(--good)" : "var(--warn)";

      pausedFlagSpan.textContent = pausedVal ? "å·²æš‚åœ" : "è¿è¡Œä¸­";
      pausedFlagSpan.style.color = pausedVal ? "var(--warn)" : "var(--good)";
      pausedStateText.textContent = pausedVal ? "å½“å‰çŠ¶æ€ï¼šå·²æš‚åœï¼ˆä¹°å…¥/ç©ºæŠ•ä¼šæ‹’ç»æ‰§è¡Œï¼‰" : "å½“å‰çŠ¶æ€ï¼šè¿è¡Œä¸­";

      // refresh payToken (USDT) balance
      await refreshUSDTBalance();

      // æŒ‰æƒé™ç¦ç”¨æŒ‰é’®
      const pauseBtn = document.getElementById("pause-btn");
      const unpauseBtn = document.getElementById("unpause-btn");
      pauseBtn.disabled = !isOwner || pausedVal;
      unpauseBtn.disabled = !isOwner || !pausedVal;

    }catch(e){
      console.error("refreshContractStatus error:", e);
    }
  }

  async function refreshUSDTBalance(){
    if(!provider || !contract) return;
    try{
      const payAddr = await contract.payToken();
      const dec = await getTokenDecimals(payAddr);
      const bal = await getTokenBalance(payAddr);
      contractUSDTBalanceSpan.textContent = `${ethers.utils.formatUnits(bal, dec)} (payToken: ${shortAddr(payAddr)})`;
    }catch(e){
      console.error("refreshUSDTBalance error:", e);
      contractUSDTBalanceSpan.textContent = "-";
    }
  }
  refreshBalanceBtn.addEventListener("click", refreshUSDTBalance);

  // ===== è¿æ¥é’±åŒ… =====
  async function connectWallet(){
    if(!window.ethereum){
      alert("æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å…ˆå®‰è£…æµè§ˆå™¨é’±åŒ…ã€‚");
      return;
    }
    try{
      connectBtn.disabled = true;
      connectBtn.textContent = "è¿æ¥ä¸­...";

      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      currentAccount = await signer.getAddress();

      walletAddressSpan.textContent = shortAddr(currentAccount);

      currentNetwork = await provider.getNetwork();
      if(currentNetwork.chainId !== 56){
        alert("å½“å‰ç½‘ç»œä¸æ˜¯ BNB Chain ä¸»ç½‘ï¼ˆchainId=56ï¼‰ã€‚è¯·åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ° BNB Smart Chain Mainnetã€‚");
      }

      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      await refreshContractStatus();
      connectBtn.textContent = "å·²è¿æ¥";
    }catch(e){
      console.error(e);
      alert("è¿æ¥å¤±è´¥ï¼š" + (e.message || e));
      connectBtn.textContent = "è¿æ¥ MetaMask";
    }finally{
      connectBtn.disabled = false;
    }
  }
  connectBtn.addEventListener("click", connectWallet);

  // ===== äº¤æ˜“æ„é€  & æ‰§è¡Œï¼šç»Ÿä¸€å…¥å£ =====
  async function buildAndMaybeSend({ fn, args, overrides, msgEl, tag, postRefresh }){
    // 1) é¢„æ£€æŸ¥
    if(!contract) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

    // 2) å…ˆç”Ÿæˆ dataï¼ˆä¿è¯å³ä½¿ç”¨æˆ·ç‚¹æ‹’ç»ä¹Ÿèƒ½è®°å½•ï¼‰
    let txReq;
    try{
      txReq = await contract.populateTransaction[fn](...args, overrides || {});
    }catch(e){
      // populate å¤±è´¥æ—¶ï¼Œé€€è€Œæ±‚å…¶æ¬¡ï¼šç”¨ interface ç¼–ç 
      try{
        const data = contract.interface.encodeFunctionData(fn, args);
        txReq = { to: CONTRACT_ADDRESS, data, ...(overrides || {}) };
      }catch(ee){
        throw new Error("ç”Ÿæˆ data å¤±è´¥ï¼š" + (ee.message || ee));
      }
    }
    const dataHex = txReq.data || "";
    const valueHint = (txReq.value && !ethers.BigNumber.from(txReq.value).isZero())
      ? ("value=" + ethers.utils.formatEther(txReq.value) + " BNB") : "";

    pushLog(fn, dataHex, tag || (txMode==="DATA" ? "ä»…data" : "å‡†å¤‡äº¤æ˜“"), valueHint);

    // 3) DATA æ¨¡å¼ï¼šåªå±•ç¤º data
    if(txMode === "DATA"){
      setMsg(msgEl, true, "å·²ç”Ÿæˆ calldata(data)ï¼Œæœªå‘èµ·äº¤æ˜“ï¼ˆä»…æ˜¾ç¤ºdata æ¨¡å¼ï¼‰ã€‚\nä½ å¯ä»¥åœ¨åº•éƒ¨æ—¥å¿—å¤åˆ¶æœ¬æ¬¡ dataã€‚");
      return;
    }

    // 4) SEND æ¨¡å¼ï¼šçœŸæ­£å‘äº¤æ˜“ï¼ˆè°ƒç”¨ MetaMaskï¼‰
    let tx;
    try{
      setMsg(msgEl, true, "å·²è®°å½• dataï¼Œå‡†å¤‡å‘èµ·äº¤æ˜“ï¼ˆMetaMask å°†å¼¹çª—ï¼‰ã€‚");
      tx = await contract[fn](...args, overrides || {});
      pushLog(fn, dataHex, "å·²å‘é€", "txHash=" + tx.hash);
      setMsg(msgEl, true, "äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ä¸­...\nTX: " + tx.hash);
      await tx.wait();
      pushLog(fn, dataHex, "å·²ç¡®è®¤", "txHash=" + tx.hash);
      setMsg(msgEl, true, "äº¤æ˜“å·²ç¡®è®¤ âœ…\nTX: " + tx.hash);
      if(typeof postRefresh === "function") await postRefresh();
    }catch(e){
      const msg = (e.data?.message || e.message || String(e));
      pushLog(fn, dataHex, "å¤±è´¥/æ‹’ç»", msg.slice(0, 180));
      setMsg(msgEl, false, "äº¤æ˜“å¤±è´¥/è¢«æ‹’ç»ï¼š\n" + msg);
    }
  }

  // ===== æ™®é€šè´­ä¹° =====
  document.getElementById("form-normal").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const msgEl = document.getElementById("normal-msg");
    setMsg(msgEl, true, "");

    try{
      const payType = document.getElementById("normal-payType").value;
      const payTokenAddr = normalizeAddr(document.getElementById("normal-payTokenAddr").value);
      const tokenToBuy = normalizeAddr(document.getElementById("normal-tokenToBuy").value);
      const amountPerStr = (document.getElementById("normal-amountPer").value || "").trim();
      const recipients = parseAddressList(document.getElementById("normal-recipients").value);

      if(!tokenToBuy) throw new Error("è¯·å¡«å†™ç›®æ ‡ä»£å¸åœ°å€ã€‚");
      if(!amountPerStr || Number(amountPerStr) <= 0) throw new Error("æ¯ä¸ªåœ°å€èŠ±è´¹å¿…é¡» > 0ã€‚");
      if(recipients.length === 0) throw new Error("è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªæ”¶å¸åœ°å€ã€‚");

      if(payType === "BNB"){
        const per = ethers.utils.parseEther(amountPerStr);
        const total = per.mul(recipients.length);
        await buildAndMaybeSend({
          fn: "buyWithBNB",
          args: [tokenToBuy, per, recipients],
          overrides: { value: total },
          msgEl,
          tag: "æ™®é€š/BNB",
          postRefresh: refreshContractStatus
        });
      }else if(payType === "USDT"){
        const payAddr = await contract.payToken();
        const dec = await getTokenDecimals(payAddr);
        const per = ethers.utils.parseUnits(amountPerStr, dec);
        await buildAndMaybeSend({
          fn: "buyWithPayToken",
          args: [tokenToBuy, per, recipients],
          overrides: {},
          msgEl,
          tag: "æ™®é€š/USDT",
          postRefresh: refreshUSDTBalance
        });
      }else{ // CUSTOM
        if(!payTokenAddr) throw new Error("è‡ªå®šä¹‰ä»£å¸æ¨¡å¼ï¼šè¯·å¡«å†™èŠ±è´¹ä»£å¸åœ°å€ã€‚");
        const dec = await getTokenDecimals(payTokenAddr);
        const per = ethers.utils.parseUnits(amountPerStr, dec);
        await buildAndMaybeSend({
          fn: "buyWithCustomToken",
          args: [payTokenAddr, tokenToBuy, per, recipients],
          overrides: {},
          msgEl,
          tag: "æ™®é€š/è‡ªå®šä¹‰",
          postRefresh: refreshContractStatus
        });
      }

    }catch(err){
      console.error(err);
      setMsg(msgEl, false, err.message || String(err));
    }
  });

  // ===== é™é¢è´­ä¹° =====
  document.getElementById("form-limited").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const msgEl = document.getElementById("limited-msg");
    setMsg(msgEl, true, "");

    try{
      const payType = document.getElementById("limited-payType").value;
      const payTokenAddr = normalizeAddr(document.getElementById("limited-payTokenAddr").value);
      const tokenToBuy = normalizeAddr(document.getElementById("limited-tokenToBuy").value);
      const rows = parseLimitedParams(document.getElementById("limited-params").value);

      if(!tokenToBuy) throw new Error("è¯·å¡«å†™ç›®æ ‡ä»£å¸åœ°å€ã€‚");

      const tokenDec = await getTokenDecimals(tokenToBuy);

      if(payType === "BNB"){
        let totalMax = ethers.BigNumber.from(0);
        const params = rows.map(r=>{
          const maxPay = ethers.utils.parseEther(r.maxPay || "0");
          if(maxPay.lte(0)) throw new Error("æœ€å¤§èŠ±è´¹å¿…é¡» > 0ï¼ˆåœ°å€ï¼š" + r.addr + "ï¼‰");
          totalMax = totalMax.add(maxPay);
          const target = (r.target && r.target !== "0")
            ? ethers.utils.parseUnits(r.target, tokenDec)
            : ethers.BigNumber.from(0);
          return { recipient: r.addr, maxPayAmount: maxPay, targetBuyAmount: target };
        });

        await buildAndMaybeSend({
          fn: "limitedBuyWithBNB",
          args: [tokenToBuy, params],
          overrides: { value: totalMax },
          msgEl,
          tag: "é™é¢/BNB",
          postRefresh: refreshContractStatus
        });

      }else if(payType === "USDT"){
        const payAddr = await contract.payToken();
        const payDec = await getTokenDecimals(payAddr);
        const params = rows.map(r=>{
          const maxPay = ethers.utils.parseUnits(r.maxPay || "0", payDec);
          if(maxPay.lte(0)) throw new Error("æœ€å¤§èŠ±è´¹å¿…é¡» > 0ï¼ˆåœ°å€ï¼š" + r.addr + "ï¼‰");
          const target = (r.target && r.target !== "0")
            ? ethers.utils.parseUnits(r.target, tokenDec)
            : ethers.BigNumber.from(0);
          return { recipient: r.addr, maxPayAmount: maxPay, targetBuyAmount: target };
        });

        await buildAndMaybeSend({
          fn: "limitedBuyWithPayToken",
          args: [tokenToBuy, params],
          overrides: {},
          msgEl,
          tag: "é™é¢/USDT",
          postRefresh: refreshUSDTBalance
        });

      }else{ // CUSTOM
        if(!payTokenAddr) throw new Error("è‡ªå®šä¹‰ä»£å¸æ¨¡å¼ï¼šè¯·å¡«å†™èŠ±è´¹ä»£å¸åœ°å€ã€‚");
        const payDec = await getTokenDecimals(payTokenAddr);

        const params = rows.map(r=>{
          const maxPay = ethers.utils.parseUnits(r.maxPay || "0", payDec);
          if(maxPay.lte(0)) throw new Error("æœ€å¤§èŠ±è´¹å¿…é¡» > 0ï¼ˆåœ°å€ï¼š" + r.addr + "ï¼‰");
          const target = (r.target && r.target !== "0")
            ? ethers.utils.parseUnits(r.target, tokenDec)
            : ethers.BigNumber.from(0);
          return { recipient: r.addr, maxPayAmount: maxPay, targetBuyAmount: target };
        });

        await buildAndMaybeSend({
          fn: "limitedBuyWithCustomToken",
          args: [payTokenAddr, tokenToBuy, params],
          overrides: {},
          msgEl,
          tag: "é™é¢/è‡ªå®šä¹‰",
          postRefresh: refreshContractStatus
        });
      }

    }catch(err){
      console.error(err);
      setMsg(msgEl, false, err.message || String(err));
    }
  });

  // ===== æ‰¹é‡ç©ºæŠ• =====
  document.getElementById("form-airdrop").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const msgEl = document.getElementById("airdrop-msg");
    setMsg(msgEl, true, "");
    try{
      if(!provider) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const type = document.getElementById("airdrop-type").value;
      const tokenAddrCustom = normalizeAddr(document.getElementById("airdrop-tokenAddr").value);
      const amountPerStr = (document.getElementById("airdrop-amountPer").value || "").trim();
      const recipients = parseAddressList(document.getElementById("airdrop-recipients").value);

      if(!amountPerStr || Number(amountPerStr) <= 0) throw new Error("æ¯ä¸ªåœ°å€ç©ºæŠ•æ•°é‡å¿…é¡» > 0ã€‚");
      if(recipients.length === 0) throw new Error("è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªåœ°å€ã€‚");

      if(type === "BNB"){
        const per = ethers.utils.parseEther(amountPerStr);
        await buildAndMaybeSend({
          fn: "airdropBNB",
          args: [per, recipients],
          overrides: {},
          msgEl,
          tag: "ç©ºæŠ•/BNB",
          postRefresh: refreshContractStatus
        });
      }else{
        let tokenAddr;
        if(type === "USDT"){
          tokenAddr = await contract.payToken();
        }else{
          if(!tokenAddrCustom) throw new Error("è‡ªå®šä¹‰ä»£å¸ç©ºæŠ•ï¼šè¯·å¡«å†™èŠ±è´¹ä»£å¸åœ°å€ã€‚");
          tokenAddr = tokenAddrCustom;
        }
        const dec = await getTokenDecimals(tokenAddr);
        const per = ethers.utils.parseUnits(amountPerStr, dec);
        await buildAndMaybeSend({
          fn: "airdropTokenEqual",
          args: [tokenAddr, per, recipients],
          overrides: {},
          msgEl,
          tag: type === "USDT" ? "ç©ºæŠ•/USDT" : "ç©ºæŠ•/è‡ªå®šä¹‰",
          postRefresh: refreshContractStatus
        });
      }

    }catch(err){
      console.error(err);
      setMsg(msgEl, false, err.message || String(err));
    }
  });

  // ===== æç° =====
  document.getElementById("form-withdraw").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const msgEl = document.getElementById("withdraw-msg");
    setMsg(msgEl, true, "");
    try{
      if(!provider) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const type = document.getElementById("withdraw-type").value;
      const tokenAddrCustom = normalizeAddr(document.getElementById("withdraw-tokenAddr").value);
      const to = normalizeAddr(document.getElementById("withdraw-to").value);
      const amountStr = (document.getElementById("withdraw-amount").value || "").trim();

      if(!to) throw new Error("è¯·å¡«å†™æ¥æ”¶åœ°å€ã€‚");
      if(!amountStr || Number(amountStr) <= 0) throw new Error("æç°æ•°é‡å¿…é¡» > 0ã€‚");

      if(type === "BNB"){
        const amt = ethers.utils.parseEther(amountStr);
        await buildAndMaybeSend({
          fn: "withdrawBNB",
          args: [to, amt],
          overrides: {},
          msgEl,
          tag: "æç°/BNB",
          postRefresh: refreshContractStatus
        });
      }else{
        let tokenAddr;
        if(type === "USDT"){
          tokenAddr = await contract.payToken();
        }else{
          if(!tokenAddrCustom) throw new Error("æç°è‡ªå®šä¹‰ä»£å¸ï¼šè¯·å¡«å†™æç°ä»£å¸åœ°å€ã€‚");
          tokenAddr = tokenAddrCustom;
        }
        const dec = await getTokenDecimals(tokenAddr);
        const amt = ethers.utils.parseUnits(amountStr, dec);
        await buildAndMaybeSend({
          fn: "withdrawToken",
          args: [tokenAddr, to, amt],
          overrides: {},
          msgEl,
          tag: type === "USDT" ? "æç°/USDT" : "æç°/è‡ªå®šä¹‰",
          postRefresh: refreshContractStatus
        });
      }

    }catch(err){
      console.error(err);
      setMsg(msgEl, false, err.message || String(err));
    }
  });

  // ===== æŸ¥è¯¢ä½™é¢ï¼ˆä¸å‘äº¤æ˜“ï¼‰=====
  document.getElementById("form-balance").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const msgEl = document.getElementById("balance-msg");
    setMsg(msgEl, true, "");
    try{
      if(!provider) throw new Error("è¯·å…ˆè¿æ¥ MetaMaskã€‚");

      const type = document.getElementById("balance-type").value;
      const tokenAddrCustom = normalizeAddr(document.getElementById("balance-tokenAddr").value);

      if(type === "BNB"){
        const bal = await provider.getBalance(CONTRACT_ADDRESS);
        setMsg(msgEl, true, "åˆçº¦å†… BNB ä½™é¢ï¼š\n" + ethers.utils.formatEther(bal) + " BNB");
      }else{
        let tokenAddr;
        if(type === "USDT"){
          tokenAddr = await contract.payToken();
        }else{
          if(!tokenAddrCustom) throw new Error("æŸ¥è¯¢è‡ªå®šä¹‰ä»£å¸ï¼šè¯·å¡«å†™æŸ¥è¯¢ä»£å¸åœ°å€ã€‚");
          tokenAddr = tokenAddrCustom;
        }
        const dec = await getTokenDecimals(tokenAddr);
        const bal = await getTokenBalance(tokenAddr);
        setMsg(msgEl, true, `åˆçº¦å†… Token ä½™é¢ï¼ˆ${shortAddr(tokenAddr)}ï¼‰ï¼š\n${ethers.utils.formatUnits(bal, dec)}  ï¼ˆdecimals=${dec}ï¼‰`);
      }
    }catch(err){
      console.error(err);
      setMsg(msgEl, false, err.message || String(err));
    }
  });

  // ===== å®‰å…¨å¼€å…³ =====
  document.getElementById("pause-btn").addEventListener("click", async ()=>{
    const msgEl = document.getElementById("pause-msg");
    setMsg(msgEl, true, "");
    try{
      await buildAndMaybeSend({
        fn: "pause",
        args: [],
        overrides: {},
        msgEl,
        tag: "å®‰å…¨/æš‚åœ",
        postRefresh: refreshContractStatus
      });
    }catch(err){
      console.error(err);
      setMsg(msgEl, false, err.message || String(err));
    }
  });
  document.getElementById("unpause-btn").addEventListener("click", async ()=>{
    const msgEl = document.getElementById("pause-msg");
    setMsg(msgEl, true, "");
    try{
      await buildAndMaybeSend({
        fn: "unpause",
        args: [],
        overrides: {},
        msgEl,
        tag: "å®‰å…¨/æ¢å¤",
        postRefresh: refreshContractStatus
      });
    }catch(err){
      console.error(err);
      setMsg(msgEl, false, err.message || String(err));
    }
  });

  // ===== åˆæ¬¡æ¸²æŸ“ =====
  renderLogs();
  setMode("DATA");
</script>
</body>
</html>
